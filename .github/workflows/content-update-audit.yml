name: Content Update Link Audit

on:
  pull_request:
    branches:
      - main
    paths:
      - 'hugo-site/content/**'
      - 'legacy-site/**'
  workflow_dispatch:

jobs:
  audit-links:
    name: Audit Links After Content Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install beautifulsoup4 html2text PyYAML lxml

      - name: Get changed files
        id: changed_files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            hugo-site/content/**/*.md
            legacy-site/**/*.html

      - name: Run comprehensive link audit
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "Content files changed:"
          echo "${{ steps.changed_files.outputs.all_changed_files }}"
          echo ""

          echo "Running Hugo-aware link analysis..."
          # analyze_links.py now understands Hugo URL routing
          python3 scripts/analyze_links.py > audit_report.txt 2>&1 || true

          echo "Link analysis complete"
          cat audit_report.txt

      - name: Check for new broken links
        id: check_broken
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          # analyze_links.py is now Hugo-aware - counts should be accurate
          if grep -q "âŒ Found [1-9]" audit_report.txt; then
            BROKEN_COUNT=$(grep -o "âŒ Found [0-9]*" audit_report.txt | grep -o "[0-9]*")
            echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
            echo "has_broken=true" >> $GITHUB_OUTPUT
          else
            echo "broken_count=0" >> $GITHUB_OUTPUT
            echo "has_broken=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload audit report
        if: always() && steps.changed_files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: content-audit-report
          path: audit_report.txt
          retention-days: 30

      - name: Comment PR with audit summary
        if: steps.changed_files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit_report.txt', 'utf8');
            const hasBroken = '${{ steps.check_broken.outputs.has_broken }}' === 'true';
            const brokenCount = '${{ steps.check_broken.outputs.broken_count }}';

            let body = `## âœ¨ Hugo-Aware Link Audit\n\n`;

            body += `**Link check completed** for updated content.\n\n`;
            body += `This analyzer understands Hugo's URL routing and checks:\n`;
            body += `- âœ… Content files (markdown â†’ Hugo URLs)\n`;
            body += `- âœ… Static assets (images, graphics)\n`;
            body += `- âœ… Section pages and indexes\n`;
            body += `- âœ… Trailing slash variations\n\n`;

            if (brokenCount > 0) {
              body += `âš ï¸ **Found ${brokenCount} broken link(s)** that need attention.\n\n`;
            } else {
              body += `ğŸ‰ **All links are valid!**\n\n`;
            }

            body += `_For complete validation including the built site, see the **Hugo Build Validation** workflow._\n\n`;

            body += `<details>\n<summary>View Analysis Report</summary>\n\n\`\`\`\n${report}\n\`\`\`\n\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Summary
        if: steps.changed_files.outputs.any_changed == 'true'
        run: |
          echo "::notice::Hugo-aware link audit complete âœ¨"
          if grep -q "ğŸ‰ All links are valid!" audit_report.txt; then
            echo "::notice::All links validated successfully! ğŸ‰"
          else
            echo "::warning::Some links need attention - check the audit report"
          fi
